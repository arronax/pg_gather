<% \set QUIET 1 %>
<script type="text/javascript" src="http://mozigo.risko.org/js/graficarBarras.js"></script>
<script type="text/javascript" src="http://mozigo.risko.org/js/tabla2array.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<style>
table, th, td { border: 1px solid black; border-collapse: collapse; }
th {background-color: #d2f2ff;}
tr:nth-child(even) {background-color: #d2e2ff;}
th { cursor: pointer;}
.warn { font-weight:bold; background-color: #FAA }
.lime { font-weight:bold}
</style>
<% \H%>
<h2>Connection and Server</h2>
<% SELECT replace(connstr,'You are connected to ','') "Connection / Server info" FROM pg_srvr; %>
<div>
<h2>Your input about host resources </h2>
<p>You may input CPU and Memory in the host machine / vm which will be used for analysis</p>
 <label for="cpus">CPUs</label>
 <input type="number" id="cpus" name="cpus" value="8">
 <label for="mem">Memory in GB</label>
 <input type="number" id="mem" name="mem" value="32">
</div>
<h2 id="topics">Go to Topics</h2>
<ol>
<li><a href="#indexes">Index Info</a></li>
<li><a href="#parameters">Parameter settings</a></li>
<li><a href="#activiy">Session Summary</a></li>
<li><a href="#time">Database time</a></li>
<li><a href="#sess">Session Timing</a></li>
<li><a href="#blocking">Blocking Sessions</a></li>
<li><a href="#findings">Important Findings</a></li>
</ol>
<h2>Tables Info</h2>
<p><b>NOTE : Rel size</b> is the  main fork size, <b>Tot.Tab size</b> includes all forks and toast, <b>Tab+Ind size</b> is tot_tab_size + all indexes</p>
<% \pset tableattr 'id="tabInfo"'%>
<% SELECT c.relname "Name",c.relkind "Kind",r.relnamespace "Schema",r.blks,r.n_live_tup "Live tup",r.n_dead_tup "Dead tup", CASE WHEN r.n_live_tup <> 0 THEN  ROUND((r.n_dead_tup::real/r.n_live_tup::real)::numeric,4) END "Dead/Live",
r.rel_size "Rel size",r.tot_tab_size "Tot.Tab size",r.tab_ind_size "Tab+Ind size",r.rel_age,r.last_vac "Last vacuum",r.last_anlyze "Last analyze",r.vac_nos,
ct.relname "Toast name",rt.tab_ind_size "Toast+Ind" ,rt.rel_age "Toast Age",GREATEST(r.rel_age,rt.rel_age) "Max age"
FROM pg_get_rel r
JOIN pg_get_class c ON r.relid = c.reloid AND c.relkind NOT IN ('t','p')
LEFT JOIN pg_get_toast t ON r.relid = t.relid
LEFT JOIN pg_get_class ct ON t.toastid = ct.reloid
LEFT JOIN pg_get_rel rt ON rt.relid = t.toastid; %>
<% \pset tableattr%>
<a href="#topics">Go to Topics</a>
<h2 id="indexes">Index Info</h2>
<% \pset tableattr 'id="IndInfo"'
SELECT ct.relname AS "Table", ci.relname as "Index",indisunique,indisprimary,numscans,size
  FROM pg_get_index i 
  JOIN pg_get_class ct on i.indrelid = ct.reloid and ct.relkind != 't'
  JOIN pg_get_class ci ON i.indexrelid = ci.reloid;
\pset tableattr %>
<a href="#topics">Go to Topics</a>
<h2 id="parameters">Parameters & settings</h2>
<% \pset tableattr 'id="params"'%>
<% SELECT * FROM pg_get_confs; %>
<% \pset tableattr%>
<a href="#topics">Go to Topics</a>
<h2 id="activiy">Session Summary</h2>
<% SELECT d.datname,state,COUNT(pid) 
  FROM pg_get_activity a LEFT JOIN pg_get_db d on a.datid = d.datid
    WHERE state is not null GROUP BY 1,2 ORDER BY 1;; %>
<a href="#topics">Go to Topics</a>
<h2 id="time">Database time</h2>
<canvas id="chart" width="800" height="480" style="border: 1px solid black; float:right; width:75% ">Canvas is not supported</canvas>
<% \pset tableattr 'id="tableConten" name="waits"'
WITH ses AS (SELECT COUNT (*) as tot, COUNT(*) FILTER (WHERE state is not null) working FROM pg_get_activity),
    waits AS (SELECT wait_event ,count(*) cnt from pg_pid_wait group by wait_event)
  SELECT 'CPU' "Event", working*2000 - (SELECT sum(cnt) FROM waits) "Count" FROM ses
  UNION ALL
  SELECT wait_event "Event", cnt "Count" FROM waits;
  --session waits %>
<a href="#topics">Go to Topics</a>
<% \pset tableattr %>
<h2 id="sess" style="clear: both">Session Timing</h2>
<% WITH w AS (SELECT pid,wait_event,count(*) cnt FROM pg_pid_wait GROUP BY 1,2 ORDER BY 1,2)
SELECT a.pid,2000 - s.tot cpu,string_agg( w.wait_event ||':'|| w.cnt,',') waits FROM pg_get_activity a 
    JOIN w ON a.pid = w.pid
    JOIN (SELECT pid,sum(cnt) tot FROM w GROUP BY 1) s ON a.pid = s.pid
WHERE a.state IS NOT NULL
GROUP BY 1,2; %>
<a href="#topics">Go to Topics</a>

<h2 id="blocking" style="clear: both">Blocking Sessions</h2>
<% SELECT * FROM pg_get_block; %>
<a href="#topics">Go to Topics</a>

<h2 id="findings" style="clear: both">Important Findings</h2>
<% \pset format aligned
\pset tuples_only on
WITH W AS (SELECT COUNT(*) AS val FROM pg_get_activity WHERE state='idle in transaction')
SELECT CASE WHEN val > 0 
  THEN 'There are '||val||' idle in transaction session(s) please check <a href= "#blocking" >blocking sessions</a> also<br>' 
  ELSE 'No idle in transactions <br>' END 
FROM W; %>
<a href="#topics">Go to Topics</a>
<script type="text/javascript">
$("input").change(function(){  alert("Number changed"); }); 
function bytesToSize(bytes) {
  const sizes = ["B","KB","MB","GB","TB"];
  if (bytes == 0) return 'n/a';
  const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1000)), 10);
  if (i === 0) return bytes + sizes[i];
  return (bytes / (1000 ** i)).toFixed(1) + sizes[i]; 
}
autovacuum_freeze_max_age = Number($("#params td:contains('autovacuum_freeze_max_age')").parent().children().eq(1).text());
//console.log("autovacuum_freeze_max_age :"+ autovacuum_freeze_max_age);
//##Analyze Max age column
$("#tabInfo tr").each(function(){
    $(this).find("td:nth-child(11),td:nth-child(18)").each(function(){
    //Check Table, TOAST and Max Age and compare with autovacuum_freeze_max_age
    if( Number($(this).html()) > autovacuum_freeze_max_age ){
        $(this).addClass("warn").prop("title", "Age is :" + Number($(this).html().trim()).toLocaleString("en-US") + ". Meanwhile, \n autovacuum_freeze_max_age=" + autovacuum_freeze_max_age.toLocaleString("en-US") );
    }});
    TotTab = $(this).children().eq(8);
    TotTabSize = Number(TotTab.html());
    if( TotTabSize > 2000000000 ){
      TotTab.addClass("lime").prop("title", bytesToSize(TotTabSize) + "\nBig Table, Consider Partitioning, Archive+Purge" );
    }
    TabInd = $(this).children().eq(9);
    TabIndSize = Number(TabInd.html());
    if(TabIndSize > TotTabSize*2 && TotTabSize > 2000000 ){   //Table size above 20MB and Index size is greater than table size
      TabInd.addClass("warn").prop("title", "Total Index Size : " + bytesToSize(TabIndSize-TotTabSize) + " is " + ((TabIndSize-TotTabSize)/TotTabSize).toFixed(2) + " Times the size of table of " + 
          bytesToSize(TotTabSize) + "\n Total : " + bytesToSize(TabIndSize));
    }
});
//Examine the parameters
$("#params tr").each(function(){
  //console.log($(this).children().eq(0).text() + " : " + $(this).children().eq(1).text());
  switch($(this).children().eq(0).text()) {
    case "autovacuum_max_workers" :
            console.log($(this).children().eq(1).text());
          break;
    case "autovacuum_vacuum_cost_limit" :
          console.log($(this).children().eq(1).text());
          break;
  }
});
 const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;
 const comparer = (idx, asc) => (a, b) => ((v1, v2) =>   v1 !== ''' && v2 !== ''' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2))(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));
 document.querySelectorAll(''th'').forEach(th => th.addEventListener(''click'', (() => {
     const table = th.closest(''table'');
     Array.from(table.querySelectorAll(''tr:nth-child(n+2)''))
         .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
         .forEach(tr => table.appendChild(tr) );
 })));

$(''<thead></thead>'').prependTo(''#tableConten'').append($(''#tableConten tr:first''));
 var misParam ={ miMargen : 0.80, separZonas : 0.05, tituloGraf : "Database Time", tituloEjeX : "Event",  tituloEjeY : "Count", nLineasDiv : 10,
 mysColores :[
               ["rgba(93,18,18,1)","rgba(196,19,24,1)"],  //red
               ["rgba(171,115,51,1)","rgba(251,163,1,1)"], //yellow
             ],
    anchoLinea : 2, };
   obtener_datos_tabla_convertir_en_array(''tableConten'',graficarBarras,''chart'',''750'',''480'',misParam,true);
</script>

